Analysis of MSHA Inspections, Violations, and Accident Data
========================================================

```{r chunklabel}
require(reshape)
require(plyr)
require(ggplot2)
require(lubridate)
setwd('~/Code/MSHA/')
```
## Load Data

### Load Mine Data
```{r}
mdat <- read.table('./data/msha_source/Mines.TXT', header=T, sep="|", fill=T, as.is=c(1:59),quote="\"")
head(mdat)
mdat_wv <- subset(mdat, STATE == 'WV' & COAL_METAL_IND == 'C')

```

### Inspections
To periodically rebuild this WV set of records, run `./munge/01-extract-wv.R`
```{r}
idat <- read.csv("./data/wv_idat.csv")
idat <- merge(idat, mdat_wv[,c('MINE_ID','CURRENT_MINE_NAME','CURRENT_CONTROLLER_NAME')])
head(idat)
```

### Accidents
```{r}
adat <- read.table('./data/msha_source/Accidents.TXT', header=T, sep="|", fill=T, quote="\"",comment.char = "")
# WV is FIPS 54
adat <- subset(adat, FIPS_STATE_CD==54)
adat <- merge(adat, mdat_wv[,c('MINE_ID','CURRENT_MINE_NAME','CURRENT_CONTROLLER_NAME')])
adat$accident.key <- seq(1:nrow(adat))
head(adat)
```

### Violations

```{r}
vdat <- read.csv("./data/wv_vdat.csv")
vdat <- merge(vdat, mdat_wv[,c('MINE_ID','CURRENT_MINE_NAME','CURRENT_CONTROLLER_NAME')])
head(vdat)
```


Reduce mdat_wv to only mines that are not abandoned
```{r}
mdat_wv <- mdat_wv[grep('Abandoned.*',mdat_wv$CURRENT_MINE_STATUS, invert=TRUE),]
```
Reduce inspection and violation tables accordingly
```{r}
idat <- subset(idat, MINE_ID %in% mdat_wv$MINE_ID)
vdat <- subset(vdat, MINE_ID %in% mdat_wv$MINE_ID)
```
## Create a time series by mine and month

Add real dates to the various data.frames

```{r}

mdat_wv$current.status.dt <- mdy(mdat_wv$CURRENT_STATUS_DT)
idat$inspection.begin.dt <- mdy(idat$INSPECTION_BEGIN_DT)
vdat$violation.occur.dt <- mdy(vdat$VIOLATION_OCCUR_DT)
adat$accident.dt <- mdy(adat$ACCIDENT_DT)

names(adat)
names(idat)
names(vdat)
names(mdat)
```

Count violations by day.

```{r}
vxday <- ddply(vdat, .(violation.occur.dt), nrow)
names(vxday) <- c('date','vcount')
calendarHeat(subset(vxday, year(date)==2011)$date , subset(vxday, year(date)==2011)$vcount)

```

Normalize inspections, violations, and accidents into "event" objects

```{r}
events <- 
  rbind(
  data.frame(event='inspection', MINE_ID = idat$MINE_ID, event.day=idat$inspection.begin.dt, event.key=idat$EVENT_NO)
  ,
  data.frame(event='violation', MINE_ID = vdat$MINE_ID, event.day=vdat$violation.occur.dt,event.key=vdat$EVENT_NO) 
  ,
  data.frame(event='accident', MINE_ID = adat$MINE_ID, event.day=adat$accident.dt, event.key=adat$accident.key) 
  )

```
edays, short for event days, is a temporary hack


```{r}
edays<-cast(events, event.day+MINE_ID~event, value='event.key', fun.aggregate='min')



eventsRR <- subset(edays, MINE_ID == 4601318)

eventsRR$day.decimal <- decimal_date(eventsRR$event.day)

eventsRR$lastinsp <- ifelse(eventsRR$inspection > 0 & eventsRR$inspection < Inf, eventsRR$day.decimal , cummax(ifelse(eventsRR$inspection > 0 & eventsRR$inspection < Inf, eventsRR$day.decimal, 0))) 

eventsRR$lastviol <- ifelse(eventsRR$violation > 0 & eventsRR$violation < Inf, eventsRR$day.decimal , cummax(ifelse(eventsRR$violation > 0 & eventsRR$violation < Inf, eventsRR$day.decimal, 0))) 


eventsRR$lastacc <- ifelse(eventsRR$accident > 0 & eventsRR$accident < Inf, eventsRR$day.decimal , cummax(ifelse(eventsRR$accident > 0 & eventsRR$accident < Inf, eventsRR$day.decimal, 0))) 


eventsRR$sinceinsp <- eventsRR$day.decimal - eventsRR$lastinsp 
eventsRR$sinceviol <- eventsRR$day.decimal - eventsRR$lastviol
eventsRR$sinceacc <- eventsRR$day.decimal - eventsRR$lastacc

eventsRR$year <- floor(eventsRR$day.decimal)

ggplot(subset(eventsRR, year> 2000)) + 
  geom_line(aes(x=day.decimal - year, y=sinceinsp),color='blue') +
#  geom_line(aes(x=day.decimal - year, y=sinceviol),color='black') +
  geom_line(aes(x=day.decimal - year, y=sinceacc),color='red') +
 facet_wrap('year')

```
